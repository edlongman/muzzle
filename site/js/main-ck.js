// ajax variable to store latest ajax request if it needs to be aborted
function getNews(){$(".news").html('<div class="loading"><img src="img/loading.gif"></div>');amount=$('input[name="number"]').val();scope=$('select[name="date"] option:selected').val();section=$('select[name="section"] option:selected').val();keyword="";try{keyword=$.trim(keyword);validate(amount,scope,section,keyword);window.location.href.split("/").pop().match("^bbc.html")?getBBCNews(amount,scope,section,keyword):getGuardianNews(amount,scope,section,keyword)}catch(e){ajax.abort();$(".news").html('<p class="error">Please assure your input is correct ('+e+")</p>");return}}function handleGuardianNews(e){str="<ul>";$.each(e,function(e,t){headline=t[0];link=t[1];date=t[2];str+="<li>";str+='<div class="inner">';str+='<h2 class="headline">'+headline+"</h2>";str+="<article>";str+='<div class="summary--content"><img src="img/loading.gif"></div>';str+='<a href="'+link+'" class="read-more" target="_blank" tabindex="2">Full article</a>';str+="</article>";str+="</div>";str+="</li>"});str+="</ul>";$(".news").html(str).hide();$(".news").slideDown(600,function(){initializeLinkListeners()});$(".news article").hide()}function handleBBCNews(e){str="<ul>";$.each(e,function(e,t){link=t.url;headline=t.title;summary=t.description;largeThumbnail=t.large_thumb;smallThumbnail=t.small_thumb;str+="<li>";str+='<div class="inner">';str+='<h2 class="headline">'+headline+"</h2>";str+="<article>";str+='<div class="summary--content"><p>'+summary+"</p></div>";str+='<a href="'+link+'" class="read-more" target="_blank" tabindex="2">Full article</a>';str+="</article>";str+="</div>"});str+="</ul>";$(".news").html(str).hide();$(".news").slideDown(600,function(){initializeLinkListenersBBC()});$(".news article").hide()}function initializeLinkListeners(){var e=$(".headline").next("article");e.hide();$(".headline").click(function(){var t=$(this),n=t.next("article");n.slideToggle(300);e.not(n).slideUp(300);if(!t.hasClass("loaded")){getSummary(t);t.addClass("loaded")}})}function initializeLinkListenersBBC(){var e=$(".headline").next("article");e.hide();$(".headline").click(function(){var t=$(this),n=t.next("article");n.slideToggle(300);e.not(n).slideUp(300)})}function initializeTryAgain(){$(".try-again").click(function(e){e.preventDefault();$(this).hasClass("try-again--news")?getNews():$(this).hasClass("try-again--summary")&&getSummary($(this).parent().parent().parent().prev("h2"))})}function resizeSection(){option_val=$('select[name="section"] > option:selected').text();$(".form-span").html(option_val);$('select[name="section"]').width($(".form-span").width())}function resizeNumber(){$(".form-span").html($('input[name="number"]').val());$('input[name="number"]').css("width",$(".form-span").width()+2)}function resizeDate(){option_val=$('select[name="date"] > option:selected').val();$(".form-span").html(option_val);$('select[name="date"]').width($(".form-span").width()+2)}function validate(e,t,n,r){if(isNaN(e))throw"Invalid amount of "+$('select[name="date"] option:selected').val()}function getGuardianNews(e,t,n,r){today=new Date;start_time=new Date;end_time=today;switch(t){case"days":start_time.setDate(today.getDate()-e);break;case"weeks":start_time.setDate(today.getDate()-e*7);break;case"months":start_time.setMonth(today.getMonth()-e)}ajaxGuardian(start_time,end_time,n,r)}function getBBCNews(e,t,n){today=new Date;start_date=new Date;end_date=today;switch(t){case"days":start_date.setDate(today.getDate()-e);break;case"weeks":start_date.setDate(today.getDate()-e*7);break;case"months":start_date.setMonth(today.getMonth()-e)}ajaxBBC(start_date,end_date,n)}function ajaxGuardian(e,t,n,r){ajax=$.ajax({url:"guardian_feeds.php",type:"GET",dataType:"json",data:{start_time:e.f("yyyy-MM-dd"),end_time:t.f("yyyy-MM-dd"),section:n,keyword:r},success:function(e,t,n){$.each(e,function(e,t){t[2]=new Date(t[2])});handleGuardianNews(e)},error:function(e,t,n){$(".news").html('<p class="error">Couldn’t scoop the news for you&hellip; <a href="#" title="Try again" class="try-again try-again--news">Try again</a></p>');initializeTryAgain();console.log("ERROR: "+n)}})}function ajaxBBC(e,t,n){ajax=$.ajax({url:"bbc_feeds.php",type:"GET",dataType:"json",data:{start_date:e.f("yyyy-MM-dd"),end_date:end_date.f("yyyy-MM-dd"),section:n},success:function(e,t,n){handleBBCNews(e)},error:function(e,t,n){$(".news").html('<p class="error">Couldn’t scoop the news for you&hellip; <a href="#" itle="Try again" class="try-again try-again--news">Try again</a></p>');initializeTryAgain();console.log("ERROR: "+n)}})}function getSummary(e){ajax=$.ajax({url:"ots.php",type:"GET",dataType:"html",data:{to_sum:$(e).next("article").find("a.read-more").attr("href"),ratio:10},success:function(t,n,r){t=$("<div/>").html(t).text();t=="null"&&(t="No summary found.");$(e).next("article").find(".summary--content").slideUp(400,function(){$(e).next("article").find(".summary--content").html("<p>"+t+"</p>");$(e).next("article").find(".summary--content").slideDown(400)});$(e).next("article").find(".summary--content").find("a").attr("target","_blank");e.addClass("loaded")},error:function(t,n,r){$(e).next("article").find(".summary--content").html('<p class="error">Couldn’t get summary&hellip;<a href="#" title="Try again" class="try-again try-again--summary">Try again</a></p>');initializeTryAgain();console.log("ERROR in getSummary");console.log(t)}})}ajax=null;$(document).ready(function(){ajax=$.ajax();resizeSection();resizeNumber();resizeDate();$(window).resize(function(){resizeSection();resizeNumber();resizeDate()});getNews();$('select[name="section"]').change(function(){resizeSection();getNews()});$('input[name="number"]').bind("keyup input paste",function(){resizeNumber();$(this).val()!=""&&getNews();var e=$('select[name="date"] option:first-child').text(),t=e.substr(e.length-1);t=="s"&&$(this).val()==1?$('select[name="date"] option').each(function(){var e=$(this).text().slice(0,-1);$(this).text($(this).text().slice(0,-1))}):t!="s"&&$(this).val()!=1&&$('select[name="date"] option').each(function(){old_text=$(this).text();$(this).text(old_text+"s")})});$('select[name="date"]').change(function(){resizeDate();getNews()})});$(document).ajaxComplete(function(){$(".news ul li:odd").css("background-color","#f7f7f7")});ajax=null;